name: Tofu Apply

on:
  push:
    branches: ["main"]
    paths:
      - "td5/**"  # Détecte tous les fichiers modifiés sous td5/, incluant tous les dossiers OpenTofu

jobs:
  apply:
    name: "Tofu Apply"
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      id-token: write
      contents: read

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Identify changed OpenTofu directories
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          dir_names: "true"
          path: "td5/"
          separator: ","

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.APPLY_ROLE_ARN }}
          aws-region: us-east-2

      - name: Install OpenTofu
        uses: opentofu/setup-opentofu@v1

      - name: Run Tofu Apply for each changed directory
        if: steps.changed-files.outputs.all_modified_files != ''
        env:
          CHANGED_FOLDERS: ${{ steps.changed-files.outputs.all_modified_files }}
        run: |
          for folder in $(echo $CHANGED_FOLDERS | tr ',' '\n'); do
            echo "Running Tofu Apply for $folder"
            cd $folder
            tofu init -no-color -input=false
            tofu apply -no-color -input=false -lock-timeout=60m -auto-approve
            cd - # Retour à la racine
          done
